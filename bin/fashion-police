#!/usr/bin/env ruby

require 'rubygems'
require 'rainbow'
require 'fashion-police'

@fashion_police = FashionPolice.new

everything_copasetic = true

unstaged = `git diff --name-only`.split("\n")
staged = `git diff --name-only --cached`.split("\n")

files = unstaged + staged

files.each do |filename|
  next unless filename.match(/\.js$/)
  begin
    @fashion_police.investigate(File.read(filename))
  rescue FashionPolice::BadCode
    # FIXME: it's fairly obvious the clunkiness of this block
    #        means I should clean up the design
    puts filename.color("ffa452")
    @fashion_police.errors.each do |element|
      element.each do |key, value|
        puts key.to_s.color("fb3c13") + " " + value.color("ff0000")
      end
    end
    @fashion_police.errors = []
    everything_copasetic = false
  end
end

if everything_copasetic
  exit(0)
else
  puts "Commit aborted due to JavaScript style errors.".color("eefb13")
  exit(1)
end

